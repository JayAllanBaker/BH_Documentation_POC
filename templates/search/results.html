{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/htql-suggestions.css') }}" type="text/css">
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8 offset-md-2">
            <form action="{{ url_for('search.search') }}" method="GET" class="mb-4">
                <div class="input-group">
                    <div class="position-relative flex-grow-1">
                        <input type="text" name="q" class="form-control" id="htqlSearch"
                               value="{{ query }}" 
                               placeholder="Search using Health Trixss Query Language (HTQL) (e.g., patient.name:John AND condition.status:active)"
                               autocomplete="off">
                        <div id="htqlLoadingIndicator" class="position-absolute top-50 end-0 translate-middle-y pe-3 d-none">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading suggestions...</span>
                            </div>
                        </div>
                    </div>
                    <select name="type" class="form-select" style="max-width: 150px;">
                        <option value="all" {% if search_type == 'all' %}selected{% endif %}>All</option>
                        <option value="patients" {% if search_type == 'patients' %}selected{% endif %}>Patients</option>
                        <option value="documents" {% if search_type == 'documents' %}selected{% endif %}>Documents</option>
                    </select>
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </form>
            
            {% if not query %}
            <div class="alert alert-info">
                <h5>Health Trixss Query Language (HTQL) Tips:</h5>
                <p>Use HTQL syntax to perform advanced searches. Examples:</p>
                <ul>
                    <li><code>patient.name:John</code> - Search for patients named John</li>
                    <li><code>document.title:"Progress Note"</code> - Search for documents with "Progress Note" in title</li>
                    <li><code>condition.code:J45.909</code> - Search for conditions with specific code</li>
                    <li><code>patient.city:Boston AND condition.severity:severe</code> - Complex search with AND</li>
                    <li><code>document.content:"chest pain" OR document.content:"shortness of breath"</code> - Search with OR</li>
                    <li><code>NOT patient.state:California</code> - Exclude results</li>
                </ul>
                <p>Available Fields:</p>
                <ul>
                    <li>Patient: name, id, gender, city, state</li>
                    <li>Document: title, content, transcription</li>
                    <li>Condition: code, status, severity</li>
                </ul>
                <p class="mb-0"><strong>Pro tip:</strong> Use Tab or Enter to complete suggestions. Arrow keys to navigate suggestions.</p>
            </div>
            {% endif %}
            
            {% if query %}
            <div class="mb-4">
                <h4>Search Results for "{{ query }}"</h4>
                <hr>
                
                {% if patients %}
                <div class="mb-4">
                    <h5>Patients ({{ patients|length }})</h5>
                    <div class="list-group">
                        {% for patient in patients %}
                        <a href="{{ url_for('patients.view_patient', id=patient.id) }}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ patient.family_name }}, {{ patient.given_name }}</h6>
                                <small>ID: {{ patient.identifier }}</small>
                            </div>
                            <small class="text-muted">
                                {{ patient.city }}{% if patient.state %}, {{ patient.state }}{% endif %}
                                {% if patient.conditions %}
                                â€¢ {{ patient.conditions|length }} condition(s)
                                {% endif %}
                            </small>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if documents %}
                <div class="mb-4">
                    <h5>Documents ({{ documents|length }})</h5>
                    <div class="list-group">
                        {% for document in documents %}
                        <a href="{{ url_for('documents.view_document', id=document.id) }}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ document.title }}</h6>
                                <small>{{ document.updated_at.strftime('%Y-%m-%d') }}</small>
                            </div>
                            {% if document.patient %}
                            <small class="text-muted">
                                Patient: {{ document.patient.family_name }}, {{ document.patient.given_name }}
                            </small>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if not patients and not documents %}
                <div class="alert alert-warning">
                    No results found for your search.
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('htqlSearch');
    if (!searchInput) {
        console.error('Search input not found');
        return;
    }

    // Create container for suggestions
    const suggestionContainer = document.createElement('div');
    suggestionContainer.className = 'position-relative w-100';
    searchInput.parentNode.insertBefore(suggestionContainer, searchInput);
    suggestionContainer.appendChild(searchInput);

    // Set input container position
    searchInput.parentNode.style.position = 'relative';

    // Add validation indicator with improved styles
    const validationIndicator = document.createElement('div');
    validationIndicator.className = 'validation-indicator';
    validationIndicator.style.cssText = `
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 12px;
        height: 12px;
        border-radius: 50%;
        transition: background-color 0.3s ease;
        z-index: 1000;
        opacity: 1;
        pointer-events: none;
    `;
    searchInput.parentNode.appendChild(validationIndicator);

    const suggestionsList = document.createElement('ul');
    suggestionsList.className = 'suggestions-list d-none';
    suggestionContainer.appendChild(suggestionsList);

    function validateHTQLSyntax(query) {
        // Basic validation patterns
        const validFields = {
            patient: ['name', 'id', 'gender', 'city', 'state'],
            document: ['title', 'content', 'transcription'],
            condition: ['code', 'status', 'severity']
        };
        
        const validOperators = ['AND', 'OR', 'NOT'];
        const validGenderValues = ['male', 'female', 'other'];
        const validStatusValues = ['active', 'inactive', 'resolved'];
        const validSeverityValues = ['mild', 'moderate', 'severe'];
        
        try {
            // Split query and normalize tokens
            const tokens = query.split(/\s+/).map(token => {
                // Clean up spaces around colons
                return token.replace(/\s*:\s*/g, ':');
            }).filter(Boolean);

            let isValid = true;
            let message = '';
            
            tokens.forEach(token => {
                if (token.includes('.')) {
                    // Validate field reference
                    const [category, field] = token.split('.');
                    if (!validFields[category]) {
                        isValid = false;
                        message = `Invalid category: ${category}`;
                    } else if (field && !validFields[category].includes(field.split(':')[0])) {
                        isValid = false;
                        message = `Invalid field: ${field.split(':')[0]} for category ${category}`;
                    }
                    
                    // Check value if it's a field:value pair
                    if (field && field.includes(':')) {
                        const [fieldName, value] = field.split(':');
                        if (fieldName === 'gender' && value && !validGenderValues.includes(value)) {
                            isValid = false;
                            message = `Invalid gender value: ${value}`;
                        }
                    }
                } else if (token.includes(':')) {
                    // Validate field values
                    const [field, value] = token.split(':');
                    if (field.includes('gender') && value && !validGenderValues.includes(value)) {
                        isValid = false;
                        message = `Invalid gender value: ${value}`;
                    } else if (field.includes('status') && value && !validStatusValues.includes(value)) {
                        isValid = false;
                        message = `Invalid status value: ${value}`;
                    } else if (field.includes('severity') && value && !validSeverityValues.includes(value)) {
                        isValid = false;
                        message = `Invalid severity value: ${value}`;
                    }
                } else if (token && !validOperators.includes(token)) {
                    // Validate operators
                    const isOperator = validOperators.some(op => token === op);
                    const isValue = true; // Allow any non-operator value
                    if (!isOperator && !isValue) {
                        isValid = false;
                        message = `Invalid token: ${token}`;
                    }
                }
            });
            
            return { isValid, message };
        } catch (error) {
            return { isValid: false, message: 'Invalid query syntax' };
        }
    }

    // Direct event handling with validation
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        console.log('Input value:', query);

        // Always run validation
        const validation = validateHTQLSyntax(query);
        
        // Update validation indicator
        validationIndicator.style.backgroundColor = query ? 
            (validation.isValid ? '#28a745' : '#dc3545') : 'transparent';
        validationIndicator.title = validation.message || 'Valid HTQL query';
        validationIndicator.style.opacity = query ? '1' : '0';
        
        // Update submit button state
        const submitButton = this.closest('form').querySelector('button[type="submit"]');
        submitButton.disabled = query && !validation.isValid;
        
        // Show suggestions only if we have a valid pattern
        if (query.includes('.') || query.includes(':')) {
            const suggestions = generateSuggestions(query);
            if (suggestions.length > 0) {
                showSuggestions(suggestions, suggestionsList);
            } else {
                hideSuggestions(suggestionsList);
            }
        } else {
            hideSuggestions(suggestionsList);
        }
    });

    // Handle keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        if (!suggestionsList.children.length) return;

        const items = suggestionsList.querySelectorAll('li');
        const selected = suggestionsList.querySelector('.selected');
        const currentIndex = Array.from(items).indexOf(selected);

        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectSuggestion(items, currentIndex + 1);
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectSuggestion(items, currentIndex - 1);
                break;
            case 'Tab':
            case 'Enter':
                if (selected) {
                    e.preventDefault();
                    applySuggestion(selected.textContent, searchInput);
                }
                break;
            case 'Escape':
                hideSuggestions(suggestionsList);
                break;
        }
    });

    // Add validation check before form submission
    searchInput.closest('form').addEventListener('submit', function(e) {
        const query = searchInput.value.trim();
        if (query) {
            const validation = validateHTQLSyntax(query);
            if (!validation.isValid) {
                e.preventDefault();
                alert(validation.message || 'Invalid HTQL query');
            }
        }
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!suggestionContainer.contains(e.target)) {
            hideSuggestions(suggestionsList);
        }
    });
});

// Helper functions
function generateSuggestions(query) {
    const suggestions = [];
    const normalizedQuery = query.replace(/\s*:\s*/g, ':');
    
    if (normalizedQuery.includes('.')) {
        const [category, field] = normalizedQuery.split('.');
        const fields = {
            'patient': ['name', 'id', 'gender', 'city', 'state'],
            'document': ['title', 'content', 'transcription'],
            'condition': ['code', 'status', 'severity']
        };
        
        if (fields[category]) {
            suggestions.push(...fields[category]
                .filter(f => !field || f.toLowerCase().startsWith(field.toLowerCase()))
                .map(f => `${category}.${f}`));
        }
    } else if (normalizedQuery.includes(':')) {
        const [field] = normalizedQuery.split(':');
        if (field.includes('gender')) {
            suggestions.push(...['male', 'female', 'other'].map(v => `${field}:${v}`));
        } else if (field.includes('status')) {
            suggestions.push(...['active', 'inactive', 'resolved'].map(v => `${field}:${v}`));
        } else if (field.includes('severity')) {
            suggestions.push(...['mild', 'moderate', 'severe'].map(v => `${field}:${v}`));
        }
    }
    
    return suggestions;
}

function showSuggestions(suggestions, suggestionsList) {
    suggestionsList.innerHTML = suggestions
        .map(s => `<li class="suggestion-item p-2 hover-bg-light">${s}</li>`)
        .join('');
    suggestionsList.classList.remove('d-none');
}

function hideSuggestions(suggestionsList) {
    suggestionsList.classList.add('d-none');
    suggestionsList.innerHTML = '';
}

function selectSuggestion(items, index) {
    const validIndex = (index + items.length) % items.length;
    items.forEach((item, i) => {
        item.classList.toggle('selected', i === validIndex);
        if (i === validIndex) item.scrollIntoView({ block: 'nearest' });
    });
}

function applySuggestion(suggestion, input) {
    const cursorPosition = input.selectionStart;
    const inputValue = input.value;
    const beforeCursor = inputValue.substring(0, cursorPosition);
    const afterCursor = inputValue.substring(cursorPosition);
    
    // Find the last token before cursor
    const lastSpaceIndex = beforeCursor.lastIndexOf(' ');
    const start = lastSpaceIndex === -1 ? 0 : lastSpaceIndex + 1;
    
    // Construct new value
    input.value = beforeCursor.substring(0, start) + 
                  suggestion +
                  (afterCursor.startsWith(' ') ? '' : ' ') +
                  afterCursor.trim();
    
    // Position cursor after suggestion
    const newPosition = start + suggestion.length + 1;
    input.setSelectionRange(newPosition, newPosition);
    input.focus();
}
</script>
{% endblock %}
